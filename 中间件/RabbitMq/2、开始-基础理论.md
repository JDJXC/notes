## 一些说明

 ### 1、消息中间件

> 消息中间件是基于队列与消息传递技术，在网络环境中为应用系统提供同步或异步、可靠的消息传输的支撑性软件系统。
>
> -百度百科

通俗的讲：

消息中间件，从通俗的角度讲，可以视为一个在网络环境中，为应用系统提供消息传递服务的“信使”或“快递员”。它利用高效可靠的消息传递机制，帮助不同的应用、系统或服务在网络中交换数据，从而实现平台无关的数据交流。以下是关于消息中间件的详细解释：

1. 定义

   - 消息中间件是基于队列与消息传递技术，为应用系统提供同步或异步、可靠的消息传输的支撑性软件系统。
   - 它通过提供消息传递和消息排队模型，在分布式环境下扩展进程间的通信。

2. 主要功能

   - **消息传递**：允许应用程序通过发送和接收消息来进行通信，而不是直接调用对方的函数或方法。消息可以是文本、数据对象或其他形式的信息。
   - **解耦**：将发送方和接收方解耦，使它们不需要知道对方的具体实现细节、位置或运行状态。发送方只需将消息发送到中间件，而接收方可以在需要时从中间件获取消息。
   - **可靠性**：通常提供可靠的消息传递机制，确保消息不会丢失或重复传递。它可以处理消息的确认、重试和容错等问题。
   - **异步性**：支持异步通信，发送方发送消息后可以立即继续执行其他操作，而无需等待接收方的响应。

3. 使用环境

   - 消息中间件适用于需要可靠的数据传送的分布式环境。不同的对象之间通过传递消息来激活对方的事件，完成相应的操作。

4. 传递模式

   - 消息中间件一般有两种传递模式：点对点（P2P，Point-to-Point）模式和发布/订阅（Pub/Sub）模式。
     - 点对点模式：基于队列的，消息生产者发送消息到队列，消息消费者从队列中接收消息。
     - 发布/订阅模式：定义了如何向一个内容节点（称为主题，topic）发布和订阅消息。消息发布者将消息发布到某个主题，而消息订阅者则从主题中订阅消息。

5. 实际应用

   - 消息中间件在多个行业中都有广泛应用，如政务行业的数据传递交换汇总、金融行业的全国票交影像交换系统和小额支付系统、交通行业的船舶与船员管理系统，以及能源行业的信息化“SG186”工程一体化企业级信息集成平台项目等。

6. 技术选型

   - 目前开源的消息中间件有很多，如RabbitMQ、Kafka、ActiveMQ、RocketMQ等，这些中间件提供了不同的功能和性能特点，可根据实际需求进行技术选型。

### 2、应用场景

#### 1）异步处理：**提升响应速度**

比如用户注册成功后，发送邮件跟短信的可以通过消息队列发送，提高响应时间

#### 2）应用解耦：**提升系统可用性**

双11是购物狂节，用户下单后，订单系统需要通知库存系统，传统的做法就是订单系统调用库存系统的接口。

这种做法有一个缺点:

- 当库存系统出现故障时，订单就会失败。
- 订单系统和库存系统高耦合。

**引入消息队列**

订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单下单成功。

库存系统：订阅下单的消息，获取下单消息，进行库操作。
就算库存系统出现故障,消息队列也能保证消息的可靠投递,不会导致消息丢失。

#### 3）流量削峰：**解决高并发问题**

流量削峰一般在秒杀活动中应用广泛

场景:

秒杀活动，一般会因为流量过大，导致应用挂掉，为了解决这个问题，一般在应用前端加入消息队列。

作用:
1、可以控制活动人数，超过此一定阀值的订单直接丢弃(我为什么秒杀一次都没有成功过呢^^)
2、可以缓解短时间的高流量压垮应用(应用程序按自己的最大处理能力获取订单)

1、用户的请求，服务器收到之后，首先写入消息队列，加入消息队列长度超过最大值，则直接抛弃用户请求或跳转到错误页面。

2、秒杀业务根据消息队列中的请求信息，再做后续处理。

### 3、消息队列优缺点

关于消息队列的优点也就是上面列举的，就是在特殊场景下有其对应的好处，解耦、异步、削峰。

缺点有以下几个：

- 系统可用性降低
  系统引入的外部依赖越多，越容易挂掉。本来你就是 A 系统调用 BCD 三个系统的接口就好了，人 ABCD 四个系统好好的，没啥问题，你偏加个 MQ 进来，万一 MQ 挂了咋整，MQ 一挂，整套系统崩溃的，你不就完了？如何保证消息队列的高可用，可以点击这里查看。

- 系统复杂度提高
  硬生生加个 MQ 进来，你怎么[保证消息没有重复消费]？怎么[处理消息丢失的情况]？怎么保证消息传递的顺序性？头大头大，问题一大堆，痛苦不已。

- 一致性问题
  A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，咋整？你这数据就不一致了。

所以消息队列实际是一种非常复杂的架构，你引入它有很多好处，但是也得针对它带来的坏处做各种额外的技术方案和架构来规避掉，做好之后，你会发现，妈呀，系统复杂度提升了一个数量级，也许是复杂了 10 倍。但是关键时刻，用，还是得用的。

### 4、常用消息中间件

AMQP，即Advanced Message Queuing Protocol，一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同的开发语言等条件的限制。Erlang中的实现有RabbitMQ等。

JMS即Java消息服务（Java Message Service）应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。Java消息服务是一个与具体平台无关的API，绝大多数MOM提供商都对JMS提供支持。

- AMQP和JMS

MQ是消息通信的模型，并发具体实现。现在实现MQ的有两种主流方式：AMQP、JMS。

两者间的区别和联系：

JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式
JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。
JMS规定了两种消息模型；而AMQP的消息模型更加丰富

- 常见MQ产品

ActiveMQ：基于JMS
RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好
RocketMQ``：基于JMS，阿里巴巴产品，目前交由Apache基金会
Kafka：分布式消息系统，高吞吐量

其实现在主流的消息中间件就4种：kafka、ActiveMQ、RocketMQ、RabbitMQ

下面我们来看一下，他们之间有什么区别，他们分别应该用于什么场景

 1.2.1 ActiveMQ
我们先看ActiveMQ。其实一般早些的项目需要引入消息中间件，都是使用的这个MQ，但是现在用的确实不多了，说白了就是有些过时了。我们去它的官网看一看，你会发现官网已经不活跃了，好久才会更新一次。

它的单机吞吐量是万级，一些小的项目已经够用了，但对于高并发的互联网项目完全不够看。

在高可用上，使用的主从架构的实现。
在消息可靠性上，有较低的概率会丢失数据。
综合以上，其实这个产品基本可以弃用掉了，我们完全可以使用RabbitMQ来代替它。

1.2.2 RabbitMQ
RabbitMQ出现后，国内大部分公司都从ActiveMQ切换到了RabbitMQ，基本代替了activeMQ的位置。它的社区还是很活跃的。

它的单机吞吐量也是万级，对于需要支持特别高的并发的情况，它是无法担当重任的。

在高可用上，它使用的是镜像集群模式，可以保证高可用。
在消息可靠性上，它是可以保证数据不丢失的，这也是它的一大优点。

同时它也支持一些消息中间件的高级功能，如：消息重试、死信队列等。

但是，它的开发语言是erlang，国内很少有人精通erlang，所以导致无法阅读源码。
对于大多数中小型公司，不需要面对技术上挑战的情况，使用它还是比较合适的。而对于一些BAT大型互联网公司，显然它就不合适了。

1.2.3 RocketMQ
接下来我们来讨论一下我比较喜欢的MQ-RocketMQ，它是阿里开源的消息中间件，久经沙场，非常靠谱。

它支持高吞吐量，能达到10万级，能承受互联网项目高并发的挑战。

在高可用上，它使用的是分布式架构，可以搭建大规模集群，性能很高。
在消息可靠性上，通过配置，可以保证数据的绝对不丢失。
同时它支持大量的高级功能，如：延迟消息、事务消息、消息回溯、死信队列等等。

它非常适合应用于java系统架构中，因为它使用java语言开发的，我们可以去阅读源码了解更深的底层原理。

目前来看，它没有什么特别的缺点，可以支持高并发下的技术挑战，可以基于它实现分布式事务，大型互联网公司和中小型公司都可以选择使用它来作为消息中间件使用，如果我来做技术选型，我首选的中间件就是它。

1.2.4 Kafka
kafka的吞吐量被公认为中间件中的翘楚，单机可以支持十几万的并发，相当强悍。

在高可用上同样支持分布式集群部署。

在消息可靠性上，如果保证异步的性能，可能会出现消息丢失的情况，因为它保存消息时是先存到磁盘缓冲区的，如果机器出现故障，缓冲区的数据是可能丢失的。

它的功能非常的单一，就是消息的接收与发送，因此不适合应用于许多场景。

它在行业内主要应用于大数据领域，使用它进行用户行为日志的采集和计算，来实现比如“猜你喜欢”的功能。

所以，如果没有大数据的需求，一般不会选择它。

1.2.5 为什么选择RabbitMQ

- 1、ActiveMQ，性能不是很好，因此在高并发的场景下，直接被pass掉了。它的Api很完善，在中小型互联网公司可以去使用。
- 2、kafka，主要强调高性能，如果对业务需要可靠性消息的投递的时候。那么就不能够选择kafka了。但是如果做一些日志收集呢，kafka还是很好的。因为kafka的性能是十分好的。
- 3、RocketMQ，它的特点非常好。它高性能、满足可靠性、分布式事物、支持水平扩展、上亿级别的消息堆积、主从之间的切换等等。MQ的所有优点它基本都满足。但是它最大的缺点：商业版收费。因此它有许多功能是不对外提供的

### 5、`RabbitMQ`说明

 `RabbitMQ`是由`erlang`语言开发，基于`AMQP`（Advanced Message Queue 高级消息队列协议）协议实现的消息队列，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。

- 特点

RabbitMQ是使用Erlang语言开发的开源消息队列系统，基于AMQP协议来实现。
AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。

AMQP协议更多用在企业系统内，对数据一致性、稳定性和可靠性要求很高的场景，对性能和吞吐量的要求还在其次。

RabbitMQ的可靠性是非常好的，数据能够保证百分之百的不丢失。可以使用镜像队列，它的稳定性非常好。所以说在我们互联网的金融行业。对数据的稳定性和可靠性要求都非常高的情况下，我们都会选择RabbitMQ。当然没有kafka性能好，但是要比AvtiveMQ性能要好很多。也可以自己做一些性能的优化。

RabbitMQ可以构建异地双活架构，包括每一个节点存储方式可以采用磁盘或者内存的方式。

### 6、RabbitMQ 的4种集群架构

#### 1. 主备模式

 也称为 Warren (兔子窝) 模式。实现 rabbitMQ 的高可用集群，一般在并发和数据量不高的情况下，这种模式非常的好用且简单。

  也就是一个主/备方案，主节点提供读写，备用节点不提供读写。如果主节点挂了，就切换到备用节点，原来的备用节点升级为主节点提供读写服务，当原来的主节点恢复运行后，原来的主节点就变成备用节点，和 activeMQ 利用 zookeeper 做主/备一样，也可以一主多备。

 

#### 2. 远程模式

 远程模式可以实现双活的一种模式，简称 shovel 模式，所谓的 shovel 就是把消息进行不同数据中心的复制工作，可以跨地域的让两个 MQ 集群互联，远距离通信和复制。

  Shovel 就是我们可以把消息进行数据中心的复制工作，我们可以跨地域的让两个 MQ 集群互联。



#### 3. 镜像模式

  非常经典的 mirror 镜像模式，保证 100% 数据不丢失。在实际工作中也是用得最多的，并且实现非常的简单，一般互联网大厂都会构建这种镜像集群模式。

  mirror 镜像队列，目的是为了保证 rabbitMQ 数据的高可靠性解决方案，主要就是实现数据的同步，一般来讲是 2 - 3 个节点实现数据同步。对于 100% 数据可靠性解决方案，一般是采用 3 个节点。



#### 4. 多活模式

也是实现异地数据复制的主流模式，因为 shovel 模式配置比较复杂，所以一般来说，实现异地集群的都是采用这种双活 或者 多活模型来实现的。这种模式需要依赖 rabbitMQ 的 federation 插件，可以实现持续的，可靠的 AMQP 数据通信，多活模式在实际配置与应用非常的简单。

  rabbitMQ 部署架构采用双中心模式(多中心)，那么在两套(或多套)数据中心各部署一套 rabbitMQ 集群，各中心的rabbitMQ 服务除了需要为业务提供正常的消息服务外，中心之间还需要实现部分队列消息共享。

RabbitMQ集群架构参考：[RabbitMQ 的4种集群架构](https://www.jianshu.com/p/b7cc32b94d2a)

### 7、RabbitMQ核心概念

- **生产者**（Producer）：发送消息的应用。
- **消费者**（Consumer）：接收消息的应用。
- **队列**（Queue）：存储消息的缓存。
- **消息**（Message）：由生产者通过RabbitMQ发送给消费者的信息。
- **连接**（Connection）：连接RabbitMQ和应用服务器的TCP连接。
- **信道**（Channel）：连接里的一个虚拟通道，通过消息队列发送或者接收消息时，都是通过信道进行的。
- **交换机**（Exchange）：交换机负责从生产者那里接收消息，并根据交换类型分发到对应的消息队列里。
- **绑定**（Binding）：绑定是队列和交换机的一个关联连接。
- **路由键**（Routing Key）：路由键是供交换机查看并根据键来决定如何分发消息到队列的一个键，路由键可以说是消息的目的地址。
- **代理（Broker）**：接收和分发消息的应用，RabbitMQ Server就是Message Broker。
- **虚拟主机（Virtual host）**：出于多租户和安全因素设计的，把AMQP的基本组件划分到一个虚拟的分组中，类似于网络中的namespace概念。当多个不同的用户使用同一个RabbitMQ server提供的服务时，可以划分出多个vhost，每个用户在自己的vhost创建exchange/queue 等。

### 8、RabbitMQ的高级应用

**①死信队列**

**②延迟队列**

**③队列幂等性**

**④优先级队列**

**⑤惰性队列**

## 五种消息模型

![](..\assets\RabbitMq\image\5model.png)

**RabbitMQ**供了五种主要的消息模型，这些模型通过不同的**交换机**和**队列**的组合与绑定方式来实现。以下是这五种消息模型的概述：

1. **基本消息模型**：生产者将消息发送到队列，**消费者**从队列中获取消息。这个模型是最简单的消息传递模式，适用于生产者和消费者之间一对一的通信。
2. **工作队列（Work Queue）模型**：适用于耗时任务处理，避免长时间等待。多个消费者可以监听同一个队列，任务在消费者之间共享。一个消息只能被一个消费者获取，避免重复处理。
3. **广播（Fanout）模型**：消息发送到交换机，交换机将消息发送到所有绑定的队列。每个消费者有自己的队列，都能接收到所有消息。适用于需要广播消息的场景。
4. **路由（Direct）模型**：消息发送到交换机时，会指定一个路由键（Routing Key）。交换机会根据路由键将消息发送到匹配的队列。适用于需要将不同消息路由到不同队列的场景。
5. **主题（Topic）模型**：类似于Direct模型，但支持通配符路由键。队列可以使用通配符订阅感兴趣的消息。适用于复杂的消息路由场景，如根据不同的话题或事件类型路由消息。

## 参考资料

[RabbitMQ的五种消息模型 基本信息模型、work工作模型、广播-Fanout订阅模型、定向-Direct订阅模型、通配符-Topic订阅模型](https://blog.csdn.net/qq_41158114/article/details/138194329)

[RabbitMQ详解，用心看完这一篇就够了【重点】](https://blog.csdn.net/weixin_42039228/article/details/123493937)

[RabbitMQ 的4种集群架构](https://www.jianshu.com/p/b7cc32b94d2a)

[干货：RabbitMQ核心概念及工作原理](https://mp.weixin.qq.com/s?__biz=MzIxODQxMjc0MA==&mid=2247521998&idx=1&sn=d7d939e7820c884a1830c994755c5a64&chksm=97e83565a09fbc736e9f240ef0d89e70bd68ef08745cbb53b3f943647da666ef88128e322c78&scene=27)

